# ESP32S3-电子负载项目重构计划

## 一、项目分析总结

### 1. 现有架构问题

通过对项目分析，发现以下主要问题：

1. **任务管理混乱**：任务定义分散在main.cpp和our_tasks_config.cpp中，缺乏统一管理
2. **模块依赖不清晰**：模块间依赖关系隐含而非显式，不易理解和修改
3. **通信方式耦合**：任务间通信直接使用队列和全局变量，缺乏抽象层
4. **缺乏统一事件处理**：不同类型的事件处理方式不一致
5. **代码复用性低**：缺少合适的抽象和设计模式，难以复用功能模块

### 2. 现有代码结构

- **main.cpp**: 负责初始化和创建各种任务
- **our_tasks_config.cpp/h**: 包含所有任务的具体实现
- **lib/our_***：包含各功能模块的实现
  - `our_queue`: 队列通信相关
  - `our_button`: 按键处理
  - `our_encoder`: 编码器处理
  - `our_pid_controller`: PID控制器
  - `our_lvgl_interaction`: LVGL界面交互

### 3. 核心功能模块

1. **输入处理**：旋转编码器、按键
2. **硬件通信**：IIC设备(INA226、MCP4725)、ADC
3. **显示**：LVGL界面
4. **控制**：PID控制器
5. **保护**：过压保护

## 二、重构总体规划

### 1. 重构目标

1. **改善代码结构**：实现逻辑清晰、层次分明的代码结构
2. **降低模块耦合**：模块间通过明确的接口通信，减少依赖
3. **提高代码复用性**：应用合适的设计模式，提高复用性
4. **增强系统可维护性**：简化调试、日志记录和错误处理
5. **保持功能兼容**：确保重构后功能与当前一致

### 2. 架构设计方向

采用**事件驱动架构**结合**模块化设计**，新的架构将包括：

1. **硬件抽象层**：封装硬件访问操作
2. **设备驱动层**：实现具体设备的控制逻辑
3. **核心服务层**：提供事件总线、任务管理等核心服务
4. **业务逻辑层**：实现具体的业务功能
5. **界面层**：处理用户交互和显示

### 3. 拟采用的设计模式

1. **观察者模式**：用于事件通知系统
2. **工厂模式**：用于任务创建和管理
3. **策略模式**：用于不同控制策略（PID、直接DAC控制等）的切换
4. **命令模式**：封装界面交互和操作

## 三、阶段性计划

### 阶段一：基础结构重构（当前阶段）

#### 目标

1. 实现事件总线系统
2. 建立基本的任务管理器
3. 重构项目文件结构

#### 具体任务

1. **创建核心类**
   - 创建EventBus事件总线类
   - 创建TaskManager任务管理类
   - 创建Device基类和DeviceManager设备管理类

2. **重组项目文件结构**
   - 新建src/core目录放置核心功能
   - 新建src/drivers目录放置驱动层代码
   - 新建src/devices目录放置设备实现
   - 新建src/controllers目录放置控制器
   - 新建src/tasks目录放置任务实现
   - 新建src/ui目录放置UI相关代码

3. **构建统一的消息处理机制**
   - 定义事件类型枚举
   - 设计事件数据结构
   - 实现消息队列包装器

### 阶段二：功能模块重构

#### 目标

1. 重构设备驱动模块
2. 重构控制器模块
3. 重构任务功能模块

#### 具体任务

1. **重构设备模块**
   - 实现编码器设备类
   - 实现按键设备类
   - 实现INA226设备类
   - 实现MCP4725设备类

2. **重构控制器模块**
   - 实现CurrentController控制器
   - 实现PID和DirectDAC控制策略
   - 实现ProtectionController保护控制器

3. **重构任务模块**
   - 实现EncoderTask编码器任务
   - 实现ButtonTask按键任务
   - 实现DisplayTask显示任务
   - 实现其他功能任务

### 阶段三：整合与优化

#### 目标

1. 整合所有重构的模块
2. 优化性能和资源使用
3. 增强错误处理和日志记录

#### 具体任务

1. **整合功能模块**
   - 基于事件总线连接各模块
   - 调整各模块之间的交互

2. **系统优化**
   - 优化任务调度和优先级
   - 优化内存使用

3. **增强健壮性**
   - 添加错误处理机制
   - 实现日志记录系统

## 四、近期工作计划

### 第一周

1. **设计并实现事件总线**
   - 设计Event基类和EventListener接口
   - 实现EventBus核心类
   - 编写单元测试验证功能

2. **设计并实现任务管理器**
   - 设计TaskManager类
   - 实现任务创建和管理功能
   - 编写示例代码验证功能

3. **创建新的项目结构**
   - 建立目录结构
   - 迁移核心文件

### 第二周

1. **实现第一个重构模块：编码器处理**
   - 设计Encoder设备类
   - 实现EncoderTask任务类
   - 将现有编码器逻辑迁移到新结构

2. **实现控制策略接口**
   - 设计ControlStrategy接口
   - 实现PidControlStrategy和DirectDacControlStrategy

3. **编写示例代码验证功能**
   - 创建简单的测试程序验证事件总线
   - 验证任务管理器功能
   - 测试编码器模块重构效果

## 五、执行与监控

1. **版本控制**：使用Git分支管理重构过程
   - 创建`refactor/core`分支用于核心功能重构
   - 创建`refactor/tasks`分支用于任务重构
   - 创建`refactor/devices`分支用于设备重构

2. **测试计划**：
   - 为每个重构的模块编写单元测试
   - 设计集成测试验证模块间交互
   - 保持功能测试确保重构不破坏现有功能

3. **文档更新**：
   - 更新每个模块的文档
   - 编写新架构设计文档
   - 记录重构过程中的经验和教训