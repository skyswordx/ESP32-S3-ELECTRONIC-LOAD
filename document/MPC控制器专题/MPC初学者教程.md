# MPCæ§åˆ¶å™¨ï¼šä»é›¶å¼€å§‹çš„ç›´è§‚ç†è§£

## ğŸ¯ ç¬¬ä¸€æ­¥ï¼šç†è§£æ§åˆ¶çš„æœ¬è´¨

### ç”Ÿæ´»ä¸­çš„æ§åˆ¶ä¾‹å­

**å¼€è½¦æ§åˆ¶è½¦é€Ÿï¼š**
1. **ç›®æ ‡**ï¼šä¿æŒ60km/h
2. **æµ‹é‡**ï¼šå½“å‰è½¦é€Ÿ55km/h 
3. **å†³ç­–**ï¼šéœ€è¦åŠ é€Ÿ
4. **æ‰§è¡Œ**ï¼šè¸©æ²¹é—¨

**MPCæ§åˆ¶ç”µæµï¼š**
1. **ç›®æ ‡**ï¼šä¿æŒ1500mAç”µæµ
2. **æµ‹é‡**ï¼šå½“å‰ç”µæµ1200mA
3. **å†³ç­–**ï¼šéœ€è¦æé«˜DACè¾“å‡ºç”µå‹
4. **æ‰§è¡Œ**ï¼šè¾“å‡º2.8Våˆ°DAC

---

## ğŸ§  ç¬¬äºŒæ­¥ï¼šMPCçš„"è¶…èƒ½åŠ›" - é¢„æµ‹

### æ™®é€šäºº vs æœ‰é¢„çŸ¥èƒ½åŠ›çš„äºº

**æ™®é€šäººå¼€è½¦ï¼ˆPIDï¼‰ï¼š**
```
çœ‹åˆ°çº¢ç¯ â†’ è¸©åˆ¹è½¦
çœ‹åˆ°ç»¿ç¯ â†’ è¸©æ²¹é—¨
```

**æœ‰é¢„çŸ¥èƒ½åŠ›çš„äººå¼€è½¦ï¼ˆMPCï¼‰ï¼š**
```
çŸ¥é“å‰æ–¹100ç±³æœ‰çº¢ç¯ â†’ æå‰ç¼“æ…¢å‡é€Ÿ
çŸ¥é“çº¢ç¯å°†å˜ç»¿ç¯ â†’ æå‰å‡†å¤‡åŠ é€Ÿ
çŸ¥é“å‰æ–¹æœ‰é™é€Ÿ â†’ æå‰è°ƒæ•´é€Ÿåº¦
```

### MPCçš„é¢„æµ‹æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ

**ç”¨æ•°å­¦æ¨¡å‹"é¢„æµ‹æœªæ¥"ï¼š**

```cpp
// æˆ‘ä»¬çš„ç”µæµæ§åˆ¶ç³»ç»Ÿæ¨¡å‹
// ä¸‹ä¸€æ—¶åˆ»çš„ç”µæµ = 0.95 * å½“å‰ç”µæµ + 0.05 * æ§åˆ¶ç”µå‹

double predict_next_current(double current_now, double voltage_control) {
    return 0.95 * current_now + 0.05 * voltage_control;
}

// é¢„æµ‹æœªæ¥10æ­¥
void predict_future() {
    double current = 1200;  // å½“å‰ç”µæµ1200mA
    double voltage = 2.5;   // å‡è®¾è¾“å‡º2.5V
    
    for (int i = 1; i <= 10; i++) {
        current = predict_next_current(current, voltage);
        printf("ç¬¬%dæ­¥é¢„æµ‹ç”µæµ: %.1fmA\n", i, current);
    }
}
```

**è¾“å‡ºç»“æœï¼š**
```
ç¬¬1æ­¥é¢„æµ‹ç”µæµ: 1265.0mA  (1200*0.95 + 2.5*0.05*1000)
ç¬¬2æ­¥é¢„æµ‹ç”µæµ: 1326.8mA
ç¬¬3æ­¥é¢„æµ‹ç”µæµ: 1385.4mA
...
ç¬¬10æ­¥é¢„æµ‹ç”µæµ: æ¥è¿‘2500mA
```

**ç¥å¥‡ä¹‹å¤„ï¼š** MPCèƒ½çœ‹åˆ°"å¦‚æœæˆ‘ç°åœ¨è¾“å‡º2.5Vï¼Œé‚£ä¹ˆ10æ­¥ä¹‹åç”µæµä¼šå˜æˆå¤šå°‘"

---

## ğŸ¯ ç¬¬ä¸‰æ­¥ï¼šä¼˜åŒ– - æ‰¾åˆ°æœ€å¥½çš„æ§åˆ¶ç­–ç•¥

### ä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–ï¼Ÿ

**é—®é¢˜ï¼š** æœ‰å¾ˆå¤šç§æ§åˆ¶æ–¹å¼éƒ½èƒ½è¾¾åˆ°ç›®æ ‡ï¼Œå“ªç§æœ€å¥½ï¼Ÿ

**ä¾‹å­ï¼š** è¦è®©ç”µæµä»1200mAå˜åˆ°1500mAï¼Œå¯ä»¥ï¼š
1. ç«‹å³è¾“å‡ºå¾ˆé«˜çš„ç”µå‹ â†’ å¿«é€Ÿåˆ°è¾¾ï¼Œä½†å¯èƒ½è¶…è°ƒ
2. é€æ­¥å¢åŠ ç”µå‹ â†’ å¹³ç¨³ä½†æ…¢
3. å…ˆé«˜åä½çš„ç”µå‹ â†’ å¹³è¡¡é€Ÿåº¦å’Œç¨³å®šæ€§

### MPCå¦‚ä½•è¯„ä»·"å¥½å"ï¼Ÿ

**æˆæœ¬å‡½æ•° - å°±åƒç»™æ§åˆ¶æ–¹æ¡ˆæ‰“åˆ†ï¼š**

```cpp
double calculate_cost(vector<double> voltage_plan, vector<double> predicted_current) {
    double total_cost = 0;
    double target = 1500;  // ç›®æ ‡ç”µæµ1500mA
    
    for (int i = 0; i < 10; i++) {
        // 1. è·Ÿè¸ªè¯¯å·®ä»£ä»·ï¼šåç¦»ç›®æ ‡è¶Šè¿œæ‰£åˆ†è¶Šå¤š
        double tracking_error = target - predicted_current[i];
        total_cost += 1.0 * tracking_error * tracking_error;  // Q=1.0
        
        // 2. æ§åˆ¶èƒ½è€—ä»£ä»·ï¼šç”µå‹è¶Šé«˜æ‰£åˆ†è¶Šå¤š
        total_cost += 0.1 * voltage_plan[i] * voltage_plan[i];  // R=0.1
        
        // 3. æ§åˆ¶å¹³æ»‘ä»£ä»·ï¼šç”µå‹å˜åŒ–è¶Šå‰§çƒˆæ‰£åˆ†è¶Šå¤š
        if (i > 0) {
            double voltage_change = voltage_plan[i] - voltage_plan[i-1];
            total_cost += 0.01 * voltage_change * voltage_change;  // S=0.01
        }
    }
    
    return total_cost;
}
```

**æƒé‡æ¯”ä¾‹çš„æ„ä¹‰ï¼š**
- **Q=1.0ï¼ˆè·Ÿè¸ªé‡è¦æ€§ï¼‰**ï¼šç²¾ç¡®è·Ÿè¸ªæœ€é‡è¦
- **R=0.1ï¼ˆèƒ½è€—é‡è¦æ€§ï¼‰**ï¼šèŠ‚èƒ½ä¹Ÿé‡è¦ï¼Œä½†æ²¡è·Ÿè¸ªé‡è¦
- **S=0.01ï¼ˆå¹³æ»‘é‡è¦æ€§ï¼‰**ï¼šå¹³ç¨³æ§åˆ¶æœ‰ä¸€å®šä»·å€¼

### ä¼˜åŒ–è¿‡ç¨‹å°±åƒ"è¯•é”™+æ”¹è¿›"ï¼š

```cpp
void find_best_control() {
    vector<double> best_voltage_plan = {2.5, 2.5, 2.5, 2.5, 2.5};  // åˆå§‹æ–¹æ¡ˆ
    double best_cost = 99999;
    
    // å°è¯•å¾ˆå¤šä¸åŒçš„ç”µå‹æ–¹æ¡ˆ
    for (intè¯•éªŒæ¬¡æ•° = 0; è¯•éªŒæ¬¡æ•° < 1000; è¯•éªŒæ¬¡æ•°++) {
        // 1. åŸºäºå½“å‰æ–¹æ¡ˆï¼Œéšæœºå¾®è°ƒç”Ÿæˆæ–°æ–¹æ¡ˆ
        vector<double> new_plan = slightly_modify(best_voltage_plan);
        
        // 2. é¢„æµ‹è¿™ä¸ªæ–°æ–¹æ¡ˆçš„æ•ˆæœ
        vector<double> predicted = predict_with_plan(new_plan);
        
        // 3. è¯„ä»·è¿™ä¸ªæ–°æ–¹æ¡ˆçš„å¥½å
        double cost = calculate_cost(new_plan, predicted);
        
        // 4. å¦‚æœæ–°æ–¹æ¡ˆæ›´å¥½ï¼Œå°±é‡‡ç”¨å®ƒ
        if (cost < best_cost) {
            best_voltage_plan = new_plan;
            best_cost = cost;
        }
    }
}
```

---

## ğŸš§ ç¬¬å››æ­¥ï¼šçº¦æŸ - éµå®ˆå®‰å…¨è§„åˆ™

### ä¸ºä»€ä¹ˆéœ€è¦çº¦æŸï¼Ÿ

**æ— çº¦æŸçš„ä¼˜åŒ–å¯èƒ½å¾—åˆ°å±é™©ç»“æœï¼š**
```
æœ€ä¼˜è§£ï¼šè¾“å‡º10Vç”µå‹  â† è¿™ä¼šçƒ§åè®¾å¤‡ï¼
```

**æœ‰çº¦æŸçš„ä¼˜åŒ–ï¼š**
```
çº¦æŸæ¡ä»¶ï¼š
- ç”µå‹å¿…é¡»åœ¨0-3.3Vä¹‹é—´
- ç”µå‹å˜åŒ–ç‡ä¸è¶…è¿‡0.5Væ¯æ¬¡
- ç”µæµä¸èƒ½è¶…è¿‡1800mA

åœ¨è¿™äº›é™åˆ¶ä¸‹æ‰¾æœ€ä¼˜è§£
```

### çº¦æŸå¤„ç†çš„ä»£ç å®ç°ï¼š

```cpp
void apply_safety_constraints(vector<double>& voltage_plan) {
    for (int i = 0; i < voltage_plan.size(); i++) {
        // 1. ç”µå‹å¹…å€¼çº¦æŸ
        if (voltage_plan[i] > 3.3) voltage_plan[i] = 3.3;
        if (voltage_plan[i] < 0.0) voltage_plan[i] = 0.0;
        
        // 2. ç”µå‹å˜åŒ–ç‡çº¦æŸ
        if (i > 0) {
            double change = voltage_plan[i] - voltage_plan[i-1];
            if (change > 0.5) {
                voltage_plan[i] = voltage_plan[i-1] + 0.5;
            }
            if (change < -0.5) {
                voltage_plan[i] = voltage_plan[i-1] - 0.5;
            }
        }
    }
}
```

**è¿™æ ·åšçš„å¥½å¤„ï¼š**
- æ°¸è¿œä¸ä¼šè¾“å‡ºå±é™©çš„ç”µå‹
- ä¿æŠ¤è¢«æµ‹è®¾å¤‡ä¸å—å†²å‡»
- æ§åˆ¶å™¨æ€»æ˜¯å®‰å…¨å¯é çš„

---

## ğŸ”„ ç¬¬äº”æ­¥ï¼šåé€€æ—¶åŸŸç­–ç•¥ - ä¸ºä»€ä¹ˆåªæ‰§è¡Œç¬¬ä¸€æ­¥ï¼Ÿ

### æ»šåŠ¨è§„åˆ’çš„æ™ºæ…§

**è§„åˆ’5æ­¥ï¼Œåªæ‰§è¡Œç¬¬1æ­¥ï¼Œç„¶åé‡æ–°è§„åˆ’ï¼š**

```
ç¬¬1ä¸ªå‘¨æœŸï¼š
è®¡åˆ’: [2.5V, 2.6V, 2.7V, 2.8V, 2.9V]
æ‰§è¡Œ: 2.5V â† åªæ‰§è¡Œç¬¬ä¸€ä¸ª
æµ‹é‡: å®é™…ç”µæµå˜æˆäº†1250mA (è€Œä¸æ˜¯é¢„æµ‹çš„1265mA)

ç¬¬2ä¸ªå‘¨æœŸï¼š
åŸºäºæ–°çš„æµ‹é‡å€¼1250mAé‡æ–°è®¡åˆ’:
è®¡åˆ’: [2.6V, 2.7V, 2.8V, 2.9V, 3.0V]
æ‰§è¡Œ: 2.6V â† åˆåªæ‰§è¡Œç¬¬ä¸€ä¸ª
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ**
1. **æ–°ä¿¡æ¯æ›´å‡†ç¡®**ï¼šæ¯æ¬¡éƒ½æœ‰æ–°çš„æµ‹é‡å€¼
2. **çº é”™èƒ½åŠ›å¼º**ï¼šå¦‚æœé¢„æµ‹é”™äº†ï¼Œä¸‹æ¬¡èƒ½åŠæ—¶çº æ­£
3. **é€‚åº”æ€§å¥½**ï¼šç¯å¢ƒå˜åŒ–æ—¶èƒ½å¿«é€Ÿè°ƒæ•´

å°±åƒå¼€è½¦å¯¼èˆªï¼Œè™½ç„¶è§„åˆ’äº†æ•´æ¡è·¯çº¿ï¼Œä½†ä¼šæ ¹æ®å®æ—¶è·¯å†µä¸æ–­è°ƒæ•´ã€‚

---

## ğŸ“Š ç¬¬å…­æ­¥ï¼šå®Œæ•´çš„MPCæ§åˆ¶å¾ªç¯

### æ¯ä¸ªæ§åˆ¶å‘¨æœŸçš„å®Œæ•´è¿‡ç¨‹ï¼š

```cpp
void mpc_control_one_cycle() {
    // 1. è¯»å–ä¼ æ„Ÿå™¨ - "æˆ‘ç°åœ¨åœ¨å“ªé‡Œï¼Ÿ"
    double current_measurement = read_current_sensor();
    
    // 2. è®¡ç®—è¯¯å·® - "æˆ‘ç¦»ç›®æ ‡è¿˜æœ‰å¤šè¿œï¼Ÿ"
    double error = target_current - current_measurement;
    
    // 3. é¢„æµ‹æœªæ¥ - "å¦‚æœæˆ‘è¿™æ ·æ§åˆ¶ï¼Œæœªæ¥ä¼šæ€æ ·ï¼Ÿ"
    for (int plan = 1; plan <= 100; plan++) {  // å°è¯•100ç§ä¸åŒçš„æ§åˆ¶æ–¹æ¡ˆ
        vector<double> voltage_plan = generate_plan(plan);
        vector<double> predicted_current = predict_future(voltage_plan);
        
        // 4. è¯„ä»·æ–¹æ¡ˆ - "è¿™ä¸ªæ–¹æ¡ˆå¥½ä¸å¥½ï¼Ÿ"
        double cost = evaluate_plan(voltage_plan, predicted_current);
        
        // 5. é€‰æ‹©æœ€å¥½çš„æ–¹æ¡ˆ
        if (cost < best_cost) {
            best_plan = voltage_plan;
            best_cost = cost;
        }
    }
    
    // 6. æ£€æŸ¥å®‰å…¨çº¦æŸ - "è¿™ä¸ªæ–¹æ¡ˆå®‰å…¨å—ï¼Ÿ"
    apply_safety_constraints(best_plan);
    
    // 7. æ‰§è¡Œç¬¬ä¸€æ­¥ - "ç°åœ¨å°±åšç¬¬ä¸€ä¸ªåŠ¨ä½œ"
    output_voltage(best_plan[0]);
    
    // 8. è®°å½•å†å² - "ä¸ºä¸‹æ¬¡æ§åˆ¶åšå‡†å¤‡"
    last_voltage = best_plan[0];
    last_current = current_measurement;
}
```

---

## ğŸ¯ æ€»ç»“ï¼šMPCçš„æ ¸å¿ƒæ€æƒ³

### ç”¨ä¸€å¥è¯æ¦‚æ‹¬ï¼š
**MPC = ä¼šé¢„æµ‹æœªæ¥çš„æ™ºèƒ½æ§åˆ¶å™¨ï¼Œåœ¨éµå®ˆå®‰å…¨è§„åˆ™çš„å‰æä¸‹ï¼Œæ‰¾åˆ°æœ€ä¼˜çš„æ§åˆ¶ç­–ç•¥**

### å…³é”®ä¼˜åŠ¿ï¼š
1. **é¢„æµ‹æ€§**ï¼šèƒ½çœ‹åˆ°æœªæ¥ï¼Œé¿å…é—®é¢˜å‘ç”Ÿ
2. **ä¼˜åŒ–æ€§**ï¼šä¸ä»…èƒ½æ§åˆ¶ï¼Œè¿˜èƒ½æ‰¾åˆ°æœ€å¥½çš„æ§åˆ¶æ–¹å¼
3. **çº¦æŸæ€§**ï¼šæ°¸è¿œéµå®ˆå®‰å…¨è§„åˆ™
4. **é€‚åº”æ€§**ï¼šæ ¹æ®å®é™…æƒ…å†µä¸æ–­è°ƒæ•´

### åœ¨ç”µå­è´Ÿè½½ä¸­çš„åº”ç”¨ï¼š
- **ç›®æ ‡**ï¼šç²¾ç¡®æ§åˆ¶ç”µæµåˆ°è®¾å®šå€¼
- **é¢„æµ‹**ï¼šé¢„æµ‹æœªæ¥10æ­¥çš„ç”µæµå˜åŒ–
- **ä¼˜åŒ–**ï¼šæ‰¾åˆ°æœ€å¹³ç¨³ã€æœ€èŠ‚èƒ½çš„ç”µå‹è¾“å‡ºæ–¹æ¡ˆ
- **çº¦æŸ**ï¼šç¡®ä¿ç”µå‹åœ¨0-3.3Vï¼Œå˜åŒ–ç‡ä¸è¶…è¿‡0.5V
- **æ‰§è¡Œ**ï¼šè¾“å‡ºæœ€ä¼˜çš„DACç”µå‹

è¿™å°±æ˜¯MPCæ§åˆ¶å™¨çš„å·¥ä½œåŸç†ï¼å®ƒæ¯”PIDæ§åˆ¶å™¨æ›´æ™ºèƒ½ï¼Œä½†ä¹Ÿæ›´å¤æ‚ã€‚å¯¹äºéœ€è¦é«˜ç²¾åº¦ã€å¤šçº¦æŸçš„æ§åˆ¶åœºåˆï¼ŒMPCæ˜¯éå¸¸ä¼˜ç§€çš„é€‰æ‹©ã€‚
